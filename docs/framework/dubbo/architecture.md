# 架构



## 架构图

![dubbo-architecture](image/dubbo-architecture.jpg)

##  角色说明

| 角色      | 角色说明                               |
| --------- | -------------------------------------- |
| Provider  | 暴露服务的服务提供方                   |
| Consumer  | 调用远程服务的服务消费方               |
| Registry  | 服务注册与发现的注册中心               |
| Monitor   | 统计服务的调用次数和调用时间的监控中心 |
| Container | 服务运行容器                           |



## 调用关系说明

1. `服务容器`负责**启动**，**加载**，**运行**服务提供者。
2. `服务提供者`在启动时，向`注册中心`**注册**自己提供的服务。
3. `服务消费者`在启动时，向`注册中心`**订阅**自己所需的服务。
4. `注册中心`返回服务提供者地址列表给`消费者`，如果有变更，注册中心将**基于长连接推送变更数据**给`消费者`。
5. `服务消费者`，从提供者地址列表中，基于**软负载均衡算法**，选一台提供者进行调用，如果调用失败，再选另一台调用。
6. `服务消费者`和`提供者`，在内存中累计调用次数和调用时间，定时每分钟发送一次统计数据到`监控中心`。



## 架构特性

### 连通性

- `注册中心`负责服务地址的**注册**与**查找**，相当于**目录服务**，`服务提供者`和`消费者`只在启动时与注册中心交互，`注册中心`**不转发请求**，压力较小。
- `监控中心`负责统计各服务调用次数，调用时间等，统计**先在内存汇总后每分钟一次发送到监控中心服务器**，并以报表展示。
- `服务提供者`向`注册中心`注册其提供的服务，并汇报调用时间到`监控中心`，此时间*不包含网络开销*。
- `服务消费者`向`注册中心`获取服务提供者地址列表，并**根据负载算法直接调用提供者**，同时汇报调用时间到监控中心，此时间*包含网络开销*。
- `注册中心`、`服务提供者`、`服务消费者`三者之间均为**长连接**，`监控中心`除外。
- `注册中心`通过长连接感知`服务提供者`的存在，`服务提供者`宕机，`注册中心`将立即推送事件`通知消费者`。
- `注册中心`和`监控中心`全部宕机，**不影响已运行的提供者和消费者，消费者在本地缓存了提供者列表**。
- `注册中心`和`监控中心`都是**可选**的，`服务消费者`可以**直连**`服务提供者`。



### 健壮性

- `监控中心`宕掉**不影响**使用，只是丢失部分采样数据。
- 数据库宕掉后，`注册中心`仍能通过**缓存**提供服务列表查询，但**不能注册新服务**。
- `注册中心`对等集群，任意一台宕掉后，将自动切换到另一台。
- `注册中心`全部宕掉后，`服务提供者`和`服务消费者`仍能**通过本地缓存通讯**。
- `服务提供者`**无状态**，任意一台宕掉后，不影响使用。
- `服务提供者`全部宕掉后，`服务消费者`应用将无法使用，并**无限次重连等待服务提供者恢复**。



### 伸缩性

- `注册中心`为对等集群，可**动态增加机器部署实例**，所有客户端将**自动发现**新的注册中心。
- `服务提供者`**无状态**，可**动态增加**机器部署实例，`注册中心`将**推送**新的`服务提供者`信息给`消费者`。



### 升级性

- 当服务集群规模进一步扩大，带动IT治理结构进一步升级，需要实现动态部署，进行流动计算，现有分布式服务架构不会带来阻力。
  未来可能是以下架构。

![dubbo-architecture-future](image/dubbo-architecture-future.jpg)

| 角色       | 角色说明                               |
| ---------- | -------------------------------------- |
| Deployer   | 自动部署服务的本地代理                 |
| Repository | 仓库用于存储服务应用发布包             |
| Scheduler  | 调度中心基于访问压力自动增减服务提供者 |
| Admin      | 统一管理控制台                         |
| Registry   | 服务注册与发现的注册中心               |
| Monitor    | 统计服务的调用次数和调用时间的监控中心 |

